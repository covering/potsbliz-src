<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>POTSBLIZ - Web Interface</title>
  <script src="/jquery/jquery.js"></script>
  <script src="/jquery-ui/jquery-ui.min.js"></script>
  <script src="/jtable/jquery.jtable.min.js" type="text/javascript"></script>
  <link href="/jquery-ui-themes/sunny/jquery-ui.min.css" rel="stylesheet" type="text/css" />
  <link href="/jtable/themes/jqueryui/jtable_jqueryui.min.css" rel="stylesheet" type="text/css" />
</head>
<body>

<div id="Tabs">
  <ul>
    <li><a href="#tabs-1">Speed dial</a></li>
    <li><a href="#tabs-2">Bluetooth</a></li>
    <li><a href="#tabs-3">SIP account</a></li>
    <li><a href="#tabs-4">Change password</a></li>
    <li><a href="#tabs-5">About POTSBLIZ</a></li>
  </ul>
  <div id="tabs-1">
    <div id="SpeedDialContainer"></div>
  </div>
  <div id="tabs-2">
    <div id="BluetoothContainer"></div>
    <br />
    <div>
      <form id="discovery_form">
        <input type="checkbox" id="DiscoveryCheckbox" name="discovery">
        <label for="discovery" id="discovery_label">Search new devices</label>
      </form>
    </div>
  </div>
  <div id="tabs-3">
    <div id="SipAccountContainer"></div>
  </div>
  <div id="tabs-4">
	<form name="password_form" action="">
	  <fieldset>
	  	<table>
	  		<tr>
		    	<td><label for="oldpw" id="oldpw_label">Old password</label></td>
	    		<td><input type="text" name="oldpw" id="oldpw" size="30" value="" class="text-input" /></td>
	    		<td><label class="ui-state-error" for="oldpw" id="oldpw_error">Invalid input!</label></td>
	  		</tr>
	  		<tr>
	    		<td><label for="newpw" id="newpw_label">New password</label></td>
	    		<td><input type="password" name="newpw" id="newpw" size="30" value="" class="text-input" /></td>
	    		<td><label class="ui-state-error" for="newpw" id="newpw_error">Invalid input!</label></td>
	  		</tr>
	  		<tr>
	    		<td><label for="newpw2" id="newpw2_label">Repeat new password</label></td>
	    		<td><input type="password" name="newpw2" id="newpw2" size="30" value="" class="text-input" /></td>
	    		<td><label class="ui-state-error" for="newpw2" id="newpw2_error">Password mismatch!</label></td>
	  		</tr>
	  		<tr><td>&nbsp;</td></tr>
	  		<tr>
	    		<td><input type="submit" name="submit" class="button" id="changePasswordButton" value="Change password" /></td>
	    		<td><label for="changePasswordButton" id="submit_result"></label></td>
	  		</tr>
	  	</table>
	  </fieldset>
	</form>
  </div>
  <div id="tabs-5">
    <p>POTSBLIZ - (C) 2015 - Norbert Huffschmid</p>
    <pre id="potsbliz_info" style="white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word;  " />
  </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {

    	$('#Tabs').tabs();

        $('#SpeedDialContainer').jtable({
            title: '&nbsp;',
            jqueryuiTheme: true,
            actions: {
                listAction:   '/speeddial.py/list',
                createAction: '/speeddial.py/create',
                updateAction: '/speeddial.py/update',
                deleteAction: '/speeddial.py/delete'
            },
            fields: {
                id: {
                    key: true,
                    list: false
                },
                shortcut: {
                    title: 'Speed dial',
                    create: true,
                    edit: false,
                    width: '25%'
                },
                phonenumber: {
                    title: 'Phone number',
                    width: '25%'
                },
                comment: {
                    title: 'Comment',
                    width: '50%'
                },
            }
        });
        
        $('#BluetoothContainer').jtable({
            title: '&nbsp;',
            jqueryuiTheme: true,
            actions: {
                listAction:   '/bluetooth.py/list',
                deleteAction: '/bluetooth.py/delete'
            },
            fields: {
                device: {
                    key: true,
                    list: false
                },
                name: {
                    title: 'Device',
		          	width: '99%',
                },
                paired: {
		          	display: function (data) {
		          		if (!data.record.paired) {
		          			return '<input type="submit" onclick="pairDevice(\'' + data.record.device + '\');" value="Connect ..." />';
		          		}
                    }
                },
                connected: {
		          	display: function (data) {
		          		if (data.record.connected) {
	                		return '<a href="javascript:;" title="Disconnect" onclick="disconnectDevice(\'' + data.record.device + '\');"><img src="/images/bluetooth-active.png" alt="Connected" width="12" height="16" /></a>';
		          		}
		          		else {
	                		return '<a href="javascript:;" title="Try to Connect" onclick="connectDevice(\'' + data.record.device + '\');"><img src="/images/bluetooth-inactive.png" alt="Disconnected" width="12" height="16" /></a>';
                        }
                    }
                },
            }
        });
        
        $('#SipAccountContainer').jtable({
            jqueryuiTheme: true,
            actions: {
                listAction:   '/sip_account.py/list',
                updateAction: '/sip_account.py/update'
            },
            fields: {
                config_key: {
                	title: 'SIP Settings',
                    key: true,
                    edit: false,
                    width: '20%'
                },
                config_value: {
                    width: '80%'
                },
            }
        });

        $('#SpeedDialContainer').jtable('load');
        $('#BluetoothContainer').jtable('load');
        $('#SipAccountContainer').jtable('load');
        
        $('#discovery_form :checkbox').change(function() {
          //alert('discovery changing!')         
          if ($('#DiscoveryCheckbox').is(':checked')) {
        	$.ajax( {
  			  url: "/bluetooth.py/start_discovery",
  			  success: function(info) {
    			alert('Make your Bluetooth device visible!');
  			  },
  			  error: function(info) {
    			alert('Discovery start failed!');
  			  },
		    });
          }
          else {
        	$.ajax( {
  			  url: "/bluetooth.py/stop_discovery",
  			  error: function(info) {
    			alert('Discovery stop failed!');
  			  },
		    });
          }    
        });
        
        $('.ui-state-error').hide();
        $('#submit_result').hide();
    	$("#changePasswordButton").click(function() {
      		// validate and process change password form
      		$('#submit_result').hide()
      		$('.ui-state-error').hide();
      		var success = true;
  	  		var oldpw = $("input#oldpw").val();
  			if (oldpw == "") {
        		$("label#oldpw_error").show();
        		$("input#oldpw").focus();
        		success = false;
      		}
  	  		var newpw = $("input#newpw").val();
  			if ((newpw == "") || (newpw == oldpw)) {
        		$("label#newpw_error").show();
        		$("input#newpw").focus();
        		success = false;
      		}
  	  		var newpw2 = $("input#newpw2").val();
  			if (newpw2 != newpw) {
        		$("label#newpw2_error").show();
        		$("input#newpw2").focus();
        		success = false;
      		}
      		
      		if (success == true) {
      			var dataString = 'oldpw=' + oldpw + '&newpw=' + newpw;
			    //alert (dataString);return false;
			    $.ajax({
				    type: "POST",
				    url: "/change_password.py",
				    data: dataString,
				    dataType: "json",
				    success: function(response) {
				      $('#submit_result').text(response.Message);
				      if (response.Result == 'OK') {
					      $('#submit_result').removeClass('ui-state-error');
				      }
				      else {
					      $('#submit_result').addClass('ui-state-error');
					  }
				      $('#submit_result').fadeIn(1000);
				    }
			    });
      		}
      		return false;
      	});

      	$.ajax({
  			url: "/info.py",
  			dataType: 'text',
  			success: function(info) {
    			$("#potsbliz_info").text(info);
  			}
		});

		// reload bluetooth list periodically if bluetooth tab is selected
		setInterval(function() {
			if ($('#Tabs').tabs('option', 'selected') == 1) {
				$('#BluetoothContainer').jtable('load');
			}
		}, 3000);

        // let label blink while discovery is active 
        setInterval(function() {
          var label = $('#discovery_label');
          if ($('#DiscoveryCheckbox').is(':checked')) {
            if (label.css('visibility') == 'hidden') {
              label.css('visibility', 'visible');
            }
            else {
              label.css('visibility', 'hidden');
            }
          }
          else {
            label.css('visibility', 'visible');          
          }    
        }, 500);

    });
    
    function pairDevice(device) {
      	//alert('Trying to pair with ' + device);

      	var dataString = 'device=' + device;
	  	//alert (dataString);return false;
		$.ajax({
			type: "POST",
			url: "/bluetooth.py/pair",
			data: dataString,
			dataType: "json",
			success: function(response) {
				alert('Pairing done.');
			},
			error: function (xhr, ajaxOptions, thrownError) {
        				alert('Error: ' + xhr.status + ' - ' + thrownError);
      		},
		});
    }
    
    function connectDevice(device) {
		$.ajax({
			type: "POST",
			url: "/bluetooth.py/connect",
			data: 'device=' + device,
			dataType: "json",
		    success: function(response) {
		      if (response.Result != 'OK') {
			      alert('Cannot establish bluetooth connection.');
			      //alert(response.Message);
		      }
		    },
		});
    }
    
    function disconnectDevice(device) {
		$.ajax({
			type: "POST",
			url: "/bluetooth.py/disconnect",
			data: 'device=' + device,
			dataType: "json",
		});
    }
    
</script>

</body>
</html>